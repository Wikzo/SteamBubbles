

<!DOCTYPE html>
<meta http-equiv="content-type" content="text/html; charset=UTF8">


<style>

    text {
        font: 10px sans-serif;
    }


    text {
        font-size: 11px;
        pointer-events: none;
    }

    text.parent {
        fill: #1f77b4;
    }

    circle {
        stroke: #999;

        pointer-events: all;
    }

    circle.parent {
        fill: #1f77b4;
        fill-opacity: 1;
        stroke: steelblue;
    }

    circle.parent:hover {
        stroke: #ff7f0e;
        stroke-width: .5px;
    }

    circle.child {
        pointer-events: none;
    }

</style>
<body>
<script src="//d3js.org/d3.v3.min.js"></script>


<script type="text/javascript">

    var myMap = new Map();
    myMap.set("Action", "#5C1C2C");
    myMap.set("RPG", "#253B59");
    myMap.set("MMO", "#98D5E3");
    myMap.set("heysa", "#FFFF00");

    var diameter = 960,
            format = d3.format(",d"),
            color = d3.scale.category20c();

    var tooltip = d3.select("body")
            .append("div")
            .style("position", "absolute")
            .style("z-index", "10")
            .style("visibility", "hidden")
            .style("color", "white")
            .style("padding", "8px")
            .style("background-color", "rgba(0, 0, 0, 0.75)")
            .style("border-radius", "6px")
            .style("font", "12px sans-serif")
            .text("tooltip");

    var w = 1280,
            h = 800,
            r = 720,
            x = d3.scale.linear().range([0, r]),
            y = d3.scale.linear().range([0, r]),
            node,
            root;

    var pack = d3.layout.pack()
            .size([r, r])
            .value(function(d) { return d.score_rank; });

    var vis = d3.select("body").insert("svg:svg", "h2")
            .attr("width", w)
            .attr("height", h)
            .append("svg:g")
            .attr("transform", "translate(" + (w - r) / 2 + "," + (h - r) / 2 + ")");

    d3.json("all_data.json", function(error, data) {
        if (error) throw error;
        node = root = data;

        console.log(data);

        var b100 = [];
        var b90 = [];
        var gameNode = {"name": "GAMES_2", "children" : [b100, b90]};

        console.log(gameNode);

        // get all children's score rank
        root.children.forEach(function(d) {
            if(d.children) {
                d.children.forEach(function(game) {
                   //console.log(game.score_rank);
                    if (game.score_rank > 90)
                        gameNode.children[0].push(game);

                });
            }
        });

        
        //console.log(node);
        var nodes = pack.nodes(gameNode);


        vis.selectAll("circle")
                .data(nodes)
                .enter().append("svg:circle")
                .attr("class", function(d) { return d.children ? "parent" : "child"; })
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; })
                .attr("r", function(d) { return d.r; })
                .style("opacity", 1)
                .style("fill", function(d) {

                    if (!d.children) {
                        var parent = d.parent;
                        console.log(parent.name); // <--- how to get outer name?

                        // genre color
                        if (parent.name == "ACTION")
                            return '#9b2f3a';
                        if (parent.name == "ADVENTURE")
                            return '#576c5e';
                        if (parent.name == "CASUAL")
                            return '#dac5a8';
                        if (parent.name == "INDIE")
                            return '#93794d';
                        if (parent.name == "MMO")
                            return '#1a3f75';
                        if (parent.name == "RACING")
                            return '#093640';
                        if (parent.name == "RPG")
                            return '#04b2d9';
                        if (parent.name == "SIMULATION")
                            return '#f28f38';
                        if (parent.name == "SPORTS")
                            return '#f2be5c';
                        if (parent.name == "STRATEGY")
                            return '#f2766b';
                    }
                    else
                        return '#ffffff'; }) // <--------- COLOR
                .on("click", function(d) { return zoom(node == d ? root : d); });



        vis.selectAll("image")
                .data(nodes)
                .enter().append("svg:image")
                .attr("x", function(d) {return d.x; })
                .attr("y", function(d) { return d.y; })
                .attr("width", function(d) { return d.r; })
                .attr("height", function(d) { return d.r; })
                .style("opacity", function(d)
                {

                    // only show for zoomed in
                    return d.r > 20 ? 1 : 0;

                    // only show images for inner bubbles
                    return d.children ? 0 : 1;
                       // return 0;
                    //console.log(k);


                    if (d.r >= 5)
                        return 1;
                    else
                     return 0;

                })
                .attr("xlink:href", function(d){

                    // show steam logo for outer bubbles
                    if (d.children)
                        return "http://store.akamai.steamstatic.com/public/shared/images/header/globalheader_logo.png";

                    return "http://cdn.akamai.steamstatic.com/steam/apps/" + d.appid + "/header.jpg";
                })
                .on("mouseover", function(d){

                    if (d.children) // dont show outer bubbles
                        return;

                    tooltip.html("<b>Game: </b>" + d.name +
                            "<br/><b>Developer: </b>" + d.developer
                    + "<br/><b>Publisher: </b>" + d.publisher
                    + "<br/><b>Ranking: </b>" + d.score_rank
                    + "<br/><b>Players forever: </b>" + d.players_forever
                    +" <img src='http://store.akamai.steamstatic.com/public/shared/images/header/globalheader_logo.png' />");
                    tooltip.append("img")
                            .attr("src","http://cdn.akamai.steamstatic.com/steam/apps/" + d.appid + "/header.jpg")
                            .attr("width","230px")
                            .attr("height","107.5px");
                    tooltip.style("visibility", "visible");
                })
                .on("mousemove", function() {
                    return tooltip.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
                })
                .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
                .on("click", function(d) { return zoom(node == d ? root : d); });

        vis.selectAll("text")
                .data(nodes)
                .enter().append("svg:text")
                .attr("class", function(d) { return d.children ? "parent" : "child"; })
                .attr("x", function(d) { return d.x; })
                .attr("y", function(d) { return d.y; })
                .attr("dy", ".35em")
                .attr("text-anchor", "middle")
                .style("opacity", function(d) { return d.r > 20 ? 1 : 0; })
                .style("font", function(d)
                {
                    if (d.children)
                        return "30px sans-serif"
                    else
                        return "12px sans-serif"
                })
                .text(function(d) { return d.name; });

        //d3.select(window).on("click", function() { zoom(root); });
    });

    function zoom(d, i) {
        var k = r / d.r / 2;
        x.domain([d.x - d.r, d.x + d.r]);
        y.domain([d.y - d.r, d.y + d.r]);

        var t = vis.transition()
                .duration(d3.event.altKey ? 7500 : 750);

        console.log(d.r);


        t.selectAll("image")
                .attr("x", function(d) { return x(d.x); }) // <-- offset images correctly??
                .attr("y", function(d) { return y(d.y); }) // <-- offset images correctly??
                //.attr("r", function(d) { return k * d.r; })
                .attr("width", function(d) { return k*d.r; })
                .attr("height", function(d) { return k*d.r; })
                .style("opacity", function(d)
                {

                    // only show when zoomed in
                    //console.log(k * d.r);
                    return k * d.r > 200 ? 1 : 0;

                    if (k > 20)
                        return 1;
                    else
                        return 0;

                    //console.log(k);

                    /*// only show images for inner bubbles
                    return d.children ? 0 : 1;

                    if (d.r >= 5)
                        return 1;
                    else
                        return 0;*/
                });



        t.selectAll("circle")
                .attr("cx", function(d) { return x(d.x); })
                .attr("cy", function(d) { return y(d.y); })
                .attr("r", function(d) { return k * d.r; });

        t.selectAll("text")
                .attr("x", function(d) { return x(d.x); })
                .attr("y", function(d) { return y(d.y); })
                .style("opacity", function(d) { return k * d.r > 20 ? 1 : 0; });

        node = d;
        d3.event.stopPropagation();
    }

</script>