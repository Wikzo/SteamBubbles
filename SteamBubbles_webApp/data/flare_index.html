

<!DOCTYPE html>
<meta http-equiv="content-type" content="text/html; charset=UTF8">

<head>
    <title>SteamBubbles</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
<style>

    text {
        font: 20px sans-serif;
    }


    text {
        font-size: 20px;
        pointer-events: none;
    }

    text.parent {
        fill: #1f77b4;
    }

    circle {
        stroke: #999;

        pointer-events: all;
    }

    circle.parent {
        fill: #1f77b4;
        fill-opacity: 1;
        stroke: steelblue;
    }

    circle.parent:hover {
        stroke: #ff7f0e;
        stroke-width: .5px;
    }

    circle.child {
        pointer-events: none;
    }

</style>
</head>

<body>


<h1>SteamBubbles</h1>
<button onclick="Reload()">Reload</button>



<form>
    Minimum player threshold (last two weeks): <input type="text" name="firstname"><br>
    Minimum concurrent players (last two weeks): <input type="text" name="lastname">
</form>



<p>
    <img src="http://i.imgur.com/jr4cr2A.png" />
    <label for="nRadius"
           style="display: inline-block; width: 240px; text-align: right">
        radius = <span id="nRadius-value">...</span>
    </label>
    <input type="range" min="1000" max="10000" id="nRadius">


</p>



<script src="//d3js.org/d3.v3.min.js"></script>




<script type="text/javascript">

    // input fields and more:
    // http://www.d3noob.org/2014/04/using-html-inputs-with-d3js.html
    // https://gist.github.com/bjtucker/fd3aa6e64d565962f1c1

    // when the input range changes update the circle
    d3.select("#nRadius").on("input", function() {
        //update(+this.value);
        console.log(this.value);

        minimumPlayersLastTwoWeekThreshold = this.value;
    });

    var minimumPlayersLastTwoWeekThreshold = 5000;

    // access external JSON data in Chrome:
    // https://stackoverflow.com/questions/20035101/no-access-control-allow-origin-header-is-present-on-the-requested-resource

    var action = {name:"ACTION", url:"http://steamspy.com/api.php?request=genre&genre=Action"};
    var adventure = {name:"ADVENTURE", url:"http://steamspy.com/api.php?request=genre&genre=Adventure"};
    var casual = {name:"CASUAL", url:"http://steamspy.com/api.php?request=genre&genre=Casual"};
    var indie = {name:"INDIE", url:"http://steamspy.com/api.php?request=genre&genre=Indie"};
    var mmo = {name:"MMO", url:"http://steamspy.com/api.php?request=genre&genre=Massively"};
    var racing = {name:"RACING", url:"http://steamspy.com/api.php?request=genre&genre=Racing"};
    var rpg = {name:"RPG", url:"http://steamspy.com/api.php?request=genre&genre=RPG"};
    var simulation = {name:"SIMULATION", url:"http://steamspy.com/api.php?request=genre&genre=Simulation"};
    var sports = {name:"SPORTS", url:"http://steamspy.com/api.php?request=genre&genre=Sports"};
    var strategy = {name:"STRATEGY", url:"http://steamspy.com/api.php?request=genre&genre=Strategy"};

    var URLs = [action, adventure, casual, indie, mmo, racing, rpg, simulation, sports, strategy];

    var actionData = {"children": []};
    var adventureData ={"children": []};
    var casualData = {"children": []};
    var indieData = {"children": []};
    var mmoData ={"children": []};
    var racingData ={"children": []};
    var rpgData = {"children": []};
    var simulationData = {"children": []};
    var sportsData ={"children": []};
    var strategyData ={"children": []};

    /*var arr = new Array();
    // or var arr = [];
    arr.push('value1');
    arr.push('value2');*/

    var allCombined;

    function Reload()
    {
        loadingIndex = 0;
        LoadDataFromSteamSpy();
    }
    var loadingIndex = 0;
    function LoadDataFromSteamSpy()
    {
        console.log("loading");
        d3.json(URLs[loadingIndex].url, function (error, data) {

            var workAsArray = []; // This will be the resulting array
            for(var key in data)
            {
                var entry = data[key]; // This will be each of the three graded things
                entry.id = key; // e.g. "id": "assessment1"

                if (entry.players_2weeks > minimumPlayersLastTwoWeekThreshold)
                {
                    //console.log(entry);
                    workAsArray.push(entry)

                }
            }

            if (loadingIndex == 0)
            {
                actionData.children = workAsArray;
                actionData.Category = URLs[loadingIndex].name;
            }

            else if (loadingIndex == 1)
            {
                adventureData.children = workAsArray;
                adventureData.Category = URLs[loadingIndex].name;
            }
            else if (loadingIndex == 2)
            {
                casualData.children = workAsArray;
                casualData.Category = URLs[loadingIndex].name;
            }
            else if (loadingIndex == 3)
            {
                indieData.children = workAsArray;
                indieData.Category = URLs[loadingIndex].name;
            }
            else if (loadingIndex == 4)
            {
                mmoData.children = workAsArray;
                mmoData.Category = URLs[loadingIndex].name;
            }
            else if (loadingIndex == 5)
            {
                racingData.children = workAsArray;
                racingData.Category = URLs[loadingIndex].name;
            }
            else if (loadingIndex == 6)
            {
                rpgData.children = workAsArray;
                rpgData.Category = URLs[loadingIndex].name;
            }
            else if (loadingIndex == 7)
            {
                simulationData.children = workAsArray;
                simulationData.Category = URLs[loadingIndex].name;
            }
            else if (loadingIndex == 8)
            {
                sportsData.children = workAsArray;
                sportsData.Category = URLs[loadingIndex].name;
            }
            else if (loadingIndex == 9)
            {
                strategyData.children = workAsArray;
                strategyData.Category = URLs[loadingIndex].name;
            }

            data.Category = URLs[loadingIndex].name;

            DoneLoading(URLs[loadingIndex]);
        });
    }

    function DoneLoading(dataToStore)
    {
        console.log(URLs[loadingIndex].name + " done");
        loadingIndex++;

        if (loadingIndex < URLs.length)
            LoadDataFromSteamSpy();
        else
            CheckIfAllDone();
    }

    Reload();




    function TimeOutLoader()
    {
        setTimeout(LoadDataFromSteamSpy, 4000);
    }


    function CheckIfAllDone()
    {
       //allCombined = [actionData, adventureData, casualData, indieData, mmoData, racingData, rpgData, simulationData, sportsData, strategyData];

        //console.log(allCombined);

        showCircles();
    }

    var diameter = 960,
            format = d3.format(",d"),
            color = d3.scale.category20c();

    var tooltip = d3.select("body")
            .append("div")
            .style("position", "absolute")
            .style("z-index", "10")
            .style("visibility", "hidden")
            .style("color", "white")
            .style("padding", "8px")
            .style("background-color", "rgba(0, 0, 0, 0.75)")
            .style("border-radius", "6px")
            .style("font", "12px sans-serif")
            .text("tooltip");

    var w = 1280,
            h = 800,
            r = 720,
            x = d3.scale.linear().range([0, r]),
            y = d3.scale.linear().range([0, r]),
            node,
            root;

    var pack = d3.layout.pack()
            .size([r, r]).sort(function(a, b) {
                return a.score_rank - b.score_rank;
            })
            .value(function(d) { return d.score_rank; });

    var vis = d3.select("body").insert("svg:svg", "h2")
            .attr("width", w)
            .attr("height", h)
            .append("svg:g")
            .attr("transform", "translate(" + (w - r) / 2 + "," + (h - r) / 2 + ")");

    function showCircles() {
        d3.json("all_data.json", function (error, data) {

            if (error) throw error;
            node = root = data;

            var games1 = {"name": "GAMES_1", "children": [actionData, adventureData, casualData, indieData, mmoData, racingData, rpgData, simulationData, sportsData, strategyData]};
            root = games1;

            var b100 = {"children": []};
            var b90 = {"children": []};
            var b80 = {"children": []};
            var b70 = {"children": []};
            var b60 = {"children": []};
            var b50 = {"children": []};
            var b40 = {"children": []};
            var b30 = {"children": []};
            var b20 = {"children": []};
            var b10 = {"children": []};

            b100.IntervalName = "91-100%";
            b90.IntervalName = "81-90%";
            b80.IntervalName = "71-80%";
            b70.IntervalName = "61-70%";
            b60.IntervalName = "51-60%";
            b50.IntervalName = "41-50%";
            b40.IntervalName = "31-40%";
            b30.IntervalName = "21-30%";
            b20.IntervalName = "11-20%";
            b10.IntervalName = "0-10%";

            var gameNode = {"name": "GAMES_2", "children": [b100, b90, b80, b70, b60, b50, b40, b30, b20, b10]};


            // get all children's score rank
            root.children.forEach(function (d) {

               // console.log("old:");
              // console.log(d);

                if (d.children) {

                    d.children.forEach(function (game) {
                        game.Category = d.Category;

                        // console.log(d);
                       // game.Category = d.name;
                        // console.log(game);

                        if (game.score_rank > 90)
                            gameNode.children[0].children.push(game);
                        else if (game.score_rank > 80)
                            gameNode.children[1].children.push(game);
                        else if (game.score_rank > 70)
                            gameNode.children[2].children.push(game);
                        else if (game.score_rank > 50)
                            gameNode.children[4].children.push(game);
                        else if (game.score_rank > 40)
                            gameNode.children[5].children.push(game);
                        else if (game.score_rank > 30)
                            gameNode.children[6].children.push(game);
                        else if (game.score_rank > 20)
                            gameNode.children[7].children.push(game);
                        else if (game.score_rank > 10)
                            gameNode.children[8].children.push(game);
                        else
                            gameNode.children[9].children.push(game);


                    });
                }
            });

            var nodes = pack.nodes(gameNode);
            //console.log(nodes);


            vis.selectAll("circle")
                    .data(nodes)
                    .enter().append("svg:circle")
                    .attr("class", function (d) {
                        return d.children ? "parent" : "child";
                    })
                    .attr("cx", function (d) {
                        return d.x;
                    })
                    .attr("cy", function (d) {
                        return d.y;
                    })
                    .attr("r", function (d) {
                        return d.r;
                    })
                    .style("opacity", 1)
                    .style("fill", function (d) {
                        //console.log("here2: ");
                        //console.log(d);

                        // genre color
                        if (d.Category == "ACTION")
                            return '#9b2f3a';
                        else if (d.Category == "ADVENTURE")
                            return '#576c5e';
                        else if (d.Category == "CASUAL")
                            return '#dac5a8';
                        else if (d.Category == "INDIE")
                            return '#93794d';
                        else if (d.Category == "MMO")
                            return '#1a3f75';
                        else if (d.Category == "RACING")
                            return '#093640';
                        else if (d.Category == "RPG")
                            return '#04b2d9';
                        else if (d.Category == "SIMULATION")
                            return '#f28f38';
                        else if (d.Category == "SPORTS")
                            return '#f2be5c';
                        else if (d.Category == "STRATEGY")
                            return '#f2766b';
                        else
                            return "#ffffff";

                    }) // <--------- COLOR
                    .on("click", function (d) {
                        return zoom(node == d ? root : d);
                    });


            vis.selectAll("image")
                    .data(nodes)
                    .enter().append("svg:image")
                    .attr("x", function (d) {
                        return d.x - 10;
                    })
                    .attr("y", function (d) {
                        return d.y - 10;
                    })
                    .attr("width", function (d) {
                        return d.r;
                    })
                    .attr("height", function (d) {
                        return d.r;
                    })
                    .style("opacity", function (d) {
                        //return 1;
                        // only show for zoomed in
                        return d.r > 20 ? 1 : 0;

                        // only show images for inner bubbles
                        return d.children ? 0 : 1;
                        // return 0;
                        //console.log(k);


                        if (d.r >= 5)
                            return 1;
                        else
                            return 0;

                    })
                    .attr("xlink:href", function (d) {

                        // show steam logo for outer bubbles

                        /* if (d.children)
                        return "http://store.akamai.steamstatic.com/public/shared/images/header/globalheader_logo.png";

                    return "http://cdn.akamai.steamstatic.com/steam/apps/" + d.appid + "/header.jpg";*/
                })
                .on("mouseover", function(d){

                    if (d.

                                    children) // dont show outer bubbles
                        return;

                    tooltip.html("<div><b>Game: </b>" + d.name +
                            "<br/><b>Developer: </b>" + d.developer
                    + "<br/><b>Genre: </b>" + d.Category
                    + "<br/><b>Publisher: </b>" + d.publisher
                    + "<br/><b>Ranking: </b>" + d.score_rank
                    + "<br/><b>Players forever: </b>" + d.players_forever
                    +" </div>");
                    tooltip.append("img")
                            .attr("src","http://cdn.akamai.steamstatic.com/steam/apps/" + d.appid + "/header.jpg").attr("width","230px")
                            .attr("height",
                            "107.5px");
                    tooltip.style("visibility", "visible");
                })
                .on("mousemove", function() {
                    return tooltip.style("top", ( d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
                })
                .on("mouseout",
                    function(){return tooltip.style("visibility",
                            "hidden");})
                .on("click",
                    function(d) { return zoom(node == d ?
                            root : d); });

        vis.selectAll("text")
                .data(nodes)
                .enter().append("svg:text")
                .attr("class",
                function(d) { return d.children ? "parent" :
                        "child"; })
                .attr("x",
                function(d) {
                    return d.x; })
                .attr("y",
                function(d) {
                    return d.y; })
                .attr("dy", ".35em")
                .attr("text-anchor", "middle")
                .style("opacity",
                function(d) { return d.r > 20
                        ? 1 : 0; })
                .style("font", function(d)
                {
                    if (d.children)
                        return "50px sans-serif";
                    else
                        return "52px sans-serif"
                })
                .text(
                function(d) { return d.
                        IntervalName; })

        ;
            //d3.select(window).on("click", function() { zoom(root); });
    });
        }

    function zoom(d, i) {
        var k = r / d.r / 2;
        x.domain([d.x - d.r, d.x + d.r]);
        y.domain([d.y - d.r, d.y + d.r]);

        var t = vis.transition()
                .duration(d3.event.altKey ? 7500 : 750);

        //console.log(d.r);


        t.selectAll("image")
                .attr("x", function(d) { return x(d.x); }) // <-- offset images correctly??
                .attr("y", function(d) { return y(d.y); }) // <-- offset images correctly??
                //.attr("r", function(d) { return k * d.r; })
                .attr("width", function(d) { return k*d.r; })
                .attr("height", function(d) { return k*d.r; })
                .style("opacity", function(d)
                {

                    // only show when zoomed in
                    //console.log(k * d.r);
                    return k * d.r > 200 ? 1 : 0;

                    if (k > 20)
                        return 1;
                    else
                        return 0;

                    //console.log(k);

                    /*// only show images for inner bubbles
                    return d.children ? 0 : 1;

                    if (d.r >= 5)
                        return 1;
                    else
                        return 0;*/
                });



        t.selectAll("circle")
                .attr("cx", function(d) { return x(d.x); })
                .attr("cy", function(d) { return y(d.y); })
                .attr("r", function(d) { return k * d.r; });

        t.selectAll("text")
                .attr("x", function(d) { return x(d.x); })
                .attr("y", function(d) { return y(d.y); })
                .style("opacity", function(d) { return k * d.r > 20 ? 1 : 0; });

        node = d;
        d3.event.stopPropagation();
    }

</script>


</body>
</html>